name: Deploy to Reg.ru

on:
  push:
    branches:
      - main  # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –ø—É—à–µ –≤ main
      - master  # –ò–ª–∏ master, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –µ–≥–æ
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ environment secrets:
    # environment: –ö–£–ü–ö–ì
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.0'
        channel: 'stable'
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Build web app
      run: flutter build web --release --web-renderer html
      
    - name: Create .htaccess for Reg.ru
      run: |
        cat > build/web/.htaccess << 'EOF'
        # –í–∫–ª—é—á–∏—Ç—å —Å–∂–∞—Ç–∏–µ
        <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/plain
            AddOutputFilterByType DEFLATE text/html
            AddOutputFilterByType DEFLATE text/xml
            AddOutputFilterByType DEFLATE text/css
            AddOutputFilterByType DEFLATE application/xml
            AddOutputFilterByType DEFLATE application/xhtml+xml
            AddOutputFilterByType DEFLATE application/rss+xml
            AddOutputFilterByType DEFLATE application/javascript
            AddOutputFilterByType DEFLATE application/x-javascript
        </IfModule>
        
        # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
        <IfModule mod_expires.c>
            ExpiresActive on
            ExpiresByType text/css "access plus 1 year"
            ExpiresByType application/javascript "access plus 1 year"
            ExpiresByType image/png "access plus 1 year"
            ExpiresByType image/jpg "access plus 1 year"
            ExpiresByType image/jpeg "access plus 1 year"
            ExpiresByType image/gif "access plus 1 year"
            ExpiresByType image/svg+xml "access plus 1 year"
        </IfModule>
        
        # SPA routing - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ index.html
        RewriteEngine On
        RewriteBase /
        
        # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ HTTPS
        RewriteCond %{HTTPS} off
        RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
        
        # –ù–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã –∏ –ø–∞–ø–∫–∏
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        
        # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ index.html
        RewriteRule . /index.html [L]
        EOF
        
    - name: Deploy to Reg.ru via SFTP/FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.REG_RU_FTP_HOST }}
        username: ${{ secrets.REG_RU_FTP_USER }}
        password: ${{ secrets.REG_RU_FTP_PASSWORD }}
        protocol: ftps  # –ü–æ–ø—Ä–æ–±—É–π—Ç–µ ftps –≤–º–µ—Å—Ç–æ ftp
        port: 21  # –ò–ª–∏ 22 –¥–ª—è SFTP, 990 –¥–ª—è FTPS
        local-dir: ./build/web/
        server-dir: ./
        dangerous-clean-slate: false  # –ù–µ —É–¥–∞–ª—è—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.DS_Store
          .git
          .gitignore
          
    - name: Deployment summary
      run: |
        echo "‚úÖ Deployment completed successfully!"
        echo "üì¶ Build directory: build/web"
        echo "üåê Deployed to: Reg.ru /www/fastselect.ru"
        echo "üîó Site URL: https://fastselect.ru"

