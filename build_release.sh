#!/bin/bash

# üöÄ –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–±–æ—Ä–∫–∏ —Ä–µ–ª–∏–∑–∞ Photo App –¥–ª—è macOS
# –ê–≤—Ç–æ—Ä: AI Assistant
# –î–∞—Ç–∞: 23.10.2024

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É —Ä–µ–ª–∏–∑–∞ Photo App –¥–ª—è macOS..."

# –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –¥–ª—è –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
VERSION=$(date +%Y%m%d_%H%M)
ARCHIVE_NAME="photo_app_macos_release_v${VERSION}.zip"

echo "üìÖ –í–µ—Ä—Å–∏—è: $VERSION"
echo "üì¶ –ê—Ä—Ö–∏–≤: $ARCHIVE_NAME"

# –®–∞–≥ 1: –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å—ã
echo "‚èπÔ∏è –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
pkill -f photo_app || true  # –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É –µ—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–µ—Ç

# –®–∞–≥ 2: –û—á–∏—Å—Ç–∏—Ç—å —Ñ–∞–π–ª—ã –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
echo "üßπ –û—á–∏—â–∞–µ–º —Ñ–∞–π–ª—ã –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ Hive..."
rm -f ~/Library/Containers/com.example.photoApp/Data/Documents/*.lock || true

# –®–∞–≥ 3: –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à Flutter (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
echo "üîÑ –û—á–∏—â–∞–µ–º –∫—ç—à Flutter..."
flutter clean

# –®–∞–≥ 4: –ü–æ–ª—É—á–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üì• –ü–æ–ª—É—á–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
flutter pub get

# –®–∞–≥ 5: –°–æ–∑–¥–∞—Ç—å —Ä–µ–ª–∏–∑–Ω—É—é —Å–±–æ—Ä–∫—É
echo "üî® –°–æ–∑–¥–∞–µ–º —Ä–µ–ª–∏–∑–Ω—É—é —Å–±–æ—Ä–∫—É –¥–ª—è macOS..."
flutter build macos --release

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å–ø–µ—à–Ω–æ—Å—Ç—å —Å–±–æ—Ä–∫–∏
if [ ! -d "build/macos/Build/Products/Release/photo_app.app" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –°–±–æ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å!"
    exit 1
fi

echo "‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!"

# –®–∞–≥ 6: –°–æ–∑–¥–∞—Ç—å –∞—Ä—Ö–∏–≤
echo "üì¶ –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ –¥–ª—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è..."
cd build/macos/Build/Products/Release

# –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∞—Ä—Ö–∏–≤—ã –µ—Å–ª–∏ –µ—Å—Ç—å
rm -f photo_app_macos_release_v*.zip

# –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∞—Ä—Ö–∏–≤
zip -r "$ARCHIVE_NAME" photo_app.app

# –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∞—Ä—Ö–∏–≤ –≤ –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞
mv "$ARCHIVE_NAME" ../../../../../

# –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞
cd ../../../../../

# –®–∞–≥ 7: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞
ARCHIVE_SIZE=$(ls -lh "$ARCHIVE_NAME" | awk '{print $5}')
echo "üìä –†–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞: $ARCHIVE_SIZE"

# –®–∞–≥ 8: –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è..."
open build/macos/Build/Products/Release/photo_app.app

echo ""
echo "üéâ –†–µ–ª–∏–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!"
echo "üìÅ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: build/macos/Build/Products/Release/photo_app.app"
echo "üì¶ –ê—Ä—Ö–∏–≤: $ARCHIVE_NAME ($ARCHIVE_SIZE)"
echo ""
echo "‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é!"
echo ""
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "   1. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
echo "   2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å"
echo "   3. –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–∏—Ç–µ –∞—Ä—Ö–∏–≤ $ARCHIVE_NAME"
