#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–±–æ—Ä–∫–∏ macOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É macOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "pubspec.yaml" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞"
    exit 1
fi

# –ü–æ–ª—É—á–∞–µ–º –≤–µ—Ä—Å–∏—é –∏–∑ pubspec.yaml
VERSION=$(grep "version:" pubspec.yaml | sed 's/version: //')
echo "üì¶ –í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: $VERSION"

# –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üì• –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
flutter pub get

# –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–±–æ—Ä–∫–∏
echo "üßπ –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–±–æ—Ä–∫–∏..."
flutter clean
flutter pub get

# –°–æ–±–∏—Ä–∞–µ–º —Ä–µ–ª–∏–∑–Ω—É—é –≤–µ—Ä—Å–∏—é
echo "üî® –°–æ–±–∏—Ä–∞–µ–º —Ä–µ–ª–∏–∑–Ω—É—é –≤–µ—Ä—Å–∏—é –¥–ª—è macOS..."
flutter build macos --release

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å —Å–±–æ—Ä–∫–∏
if [ $? -eq 0 ]; then
    echo "‚úÖ –°–±–æ—Ä–∫–∞ macOS —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
    
    # –°–æ–∑–¥–∞–µ–º DMG
    echo "üì¶ –°–æ–∑–¥–∞–µ–º DMG –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤..."
    create-dmg \
        --volname "Photo App $VERSION" \
        --window-pos 200 120 \
        --window-size 600 300 \
        --icon-size 100 \
        --icon "photo_app.app" 175 120 \
        --hide-extension "photo_app.app" \
        --app-drop-link 425 120 \
        "PhotoApp-$VERSION.dmg" \
        "build/macos/Build/Products/Release/"
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ DMG –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤ —Å–æ–∑–¥–∞–Ω: PhotoApp-$VERSION.dmg"
        echo "üìÅ –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $(du -h PhotoApp-$VERSION.dmg | cut -f1)"
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ DMG"
        exit 1
    fi
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ macOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
    exit 1
fi

echo "üéâ –ì–æ—Ç–æ–≤–æ! macOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é"
