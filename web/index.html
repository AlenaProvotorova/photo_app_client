<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <!-- Version tag for cache busting on deployment -->
  <meta name="app-version" content="1.0.2">

  <!-- Prevent caching on all browsers including mobile -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="Photo App - Управление фотографиями">
  <meta name="keywords" content="фото, приложение, управление, фотографии">
  <meta name="author" content="Photo App Team">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <!-- Android Chrome meta tags -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0175C2">
  
  <!-- Prevent text size adjustment on iOS -->
  <meta name="format-detection" content="telephone=no">

  <!-- iOS meta tags & icons -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Photo App">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>Photo App</title>
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <script>
    (function() {
      'use strict';
      
      // Определение типа браузера
      var ua = navigator.userAgent || '';
      
      // Проверка на мобильные устройства
      var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
      
      // Проверка на встроенные браузеры
      var isIOS = /iP(hone|od|ad)/.test(ua);
      var isAndroid = /Android/i.test(ua);
      var isTelegram = /Telegram/i.test(ua);
      var isInstagram = /Instagram/i.test(ua);
      var isFacebook = /(FBAN|FBAV)/i.test(ua);
      var isTwitter = /Twitter/i.test(ua);
      var isWhatsApp = /WhatsApp/i.test(ua);
      var isVK = /VK/i.test(ua);
      var isOdnoklassniki = /OKApp/i.test(ua);
      
      // Проверка поддержки WebGL (CanvasKit требует WebGL)
      var hasWebGL = (function() {
        try {
          var canvas = document.createElement('canvas');
          return !!(window.WebGLRenderingContext && 
            (canvas.getContext('webgl') || canvas.getContext('experimental-webgl')));
        } catch (e) {
          return false;
        }
      })();
      
      // Проверка поддержки SharedArrayBuffer (требуется для некоторых функций CanvasKit)
      var hasSharedArrayBuffer = typeof SharedArrayBuffer !== 'undefined';
      
      // Проверка на встроенный браузер
      var isInAppBrowser = isTelegram || isInstagram || isFacebook || isTwitter || 
                          isWhatsApp || isVK || isOdnoklassniki;
      
      // Используем HTML рендерер для всех мобильных и встроенных браузеров
      // Это самый надежный вариант для максимальной совместимости
      var useHtmlRenderer = isMobile || isInAppBrowser || !hasWebGL || !hasSharedArrayBuffer;
      
      // Отключаем Service Worker во встроенных браузерах (могут вызывать проблемы)
      var disableServiceWorker = isInAppBrowser || isIOS;
      
      // Отключаем Service Worker в проблемных браузерах ПЕРЕД инициализацией Flutter
      if (disableServiceWorker && 'serviceWorker' in navigator) {
        // Переопределяем метод register, чтобы предотвратить регистрацию
        var originalRegister = navigator.serviceWorker.register;
        navigator.serviceWorker.register = function() {
          console.log('Service Worker registration disabled for in-app browser');
          return Promise.reject(new Error('Service Worker disabled'));
        };
        
        // Отменяем регистрацию существующих Service Workers
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
          registrations.forEach(function(registration) {
            registration.unregister().then(function(success) {
              if (success) {
                console.log('Existing Service Worker unregistered');
              }
            });
          });
        });
        
        // Удаляем существующие Service Workers
        if (navigator.serviceWorker.controller) {
          navigator.serviceWorker.controller.postMessage({type: 'SKIP_WAITING'});
        }
      }
      
      // Дополнительные настройки для мобильных устройств
      if (isMobile) {
        // Предотвращаем зум по двойному тапу
        var lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
          var now = Date.now();
          if (now - lastTouchEnd <= 300) {
            event.preventDefault();
          }
          lastTouchEnd = now;
        }, false);
        
        // Предотвращаем выделение текста при долгом нажатии (на мобильных)
        document.addEventListener('contextmenu', function(e) {
          e.preventDefault();
        });
      }
      
      // Логирование для отладки (можно удалить в продакшене)
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        console.log('Flutter Web Configuration:', {
          isMobile: isMobile,
          isInAppBrowser: isInAppBrowser,
          useHtmlRenderer: useHtmlRenderer,
          disableServiceWorker: disableServiceWorker,
          hasWebGL: hasWebGL,
          hasSharedArrayBuffer: hasSharedArrayBuffer,
          userAgent: ua
        });
      }
    })();
  </script>
  <script src="flutter_bootstrap.js?v=1.0.2" async></script>
</body>
</html>
